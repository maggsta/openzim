<?php

require_once(dirname(__FILE__).'/../../odtphp/library/odf.php');
require_once(dirname(__FILE__).'/../../htmlconverter/library/htmlConverter.php');

/**
 * Anlage
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    openZIM
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Anlage extends BaseAnlage
{
	private $sections = null;

	public function getSections()
	{
		if ( $this->sections == null )
			$this->sections = SectionTable::getSectionsSorted($this->getId());
		return $this->sections;
	}

	public function save(Doctrine_Connection $conn = null)
	{  
		if ( $this->state() != self::STATE_DIRTY && !$this->isNew() )
			return;
		if ( $this->isNew() )
			$this->kuerzel = $this->getStunde()->getZim()->getPtKuerzel();
		$conn = $conn ? $conn : $this->getTable()->getConnection();
  		$conn->beginTransaction();
  		try
  		{
 			$ret = parent::save($conn);
 			$this->updateLuceneIndex();
     			$conn->commit();
 
    			return $ret;
  		}
  		catch (Exception $e)
  		{
    			$conn->rollBack();
    			throw $e;
  		}

	}

	public function delete(Doctrine_Connection $conn = null)
	{
  		$index = AnlageTable::getLuceneIndex();
 
  		foreach ($index->find('pk:'.$this->getId()) as $hit)
  		{
    			$index->delete($hit->id);
  		}
 
  		return parent::delete($conn);
	}

	public function ownedByUser($user){
		if ( !$this->getStunde() )
			return false;
		return $this->getStunde()->getZim()->getSfGuardUser()->getUsername() ==
			$user->getUsername();
	}
 
	public function getLnrStr()
    	{		
       		return sprintf('%02d',$this->getLnr());
    	}

	public function getName()
    	{		
       		return sprintf('%s%s',$this->getKuerzel(),$this->getLnrStr());
    	}

	public function updateLuceneIndex()
	{
  		$index = AnlageTable::getLuceneIndex();
 
  		// remove existing entries
  		foreach ($index->find('pk:'.$this->getId()) as $hit)
  		{
    			$index->delete($hit->id);
  		}
		Zend_Search_Lucene_Analysis_Analyzer::setDefault(
		    new Utf8NumSubstringAnalyzer());
  		$doc = new Zend_Search_Lucene_Document();
 
  		// store primary key to identify it in the search results
  		$doc->addField(Zend_Search_Lucene_Field::Keyword('pk', $this->getId()));
 
  		// index anlage fields
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('name', $this->getName(), 'utf-8'));
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('longname', $this->getLongname(), 'utf-8'));
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('ziel', $this->getZiel(), 'utf-8'));
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('kurzinhalt', $this->getKurzinhalt(), 'utf-8'));
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('methode', $this->getMethode(), 'utf-8'));
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('material', $this->getMaterial(), 'utf-8'));  		
  		$doc->addField(Zend_Search_Lucene_Field::UnStored('rolletm', $this->getRolleTm(), 'utf-8'));
  		foreach( $this->getSections() as $key => $section ){
  			$doc->addField(Zend_Search_Lucene_Field::UnStored('tip_'.$key, $section->getTip(), 'utf-8'));
  			$doc->addField(Zend_Search_Lucene_Field::UnStored('inhalt_'.$key, $section->getInhalt(), 'utf-8'));
  		}
 
  		// add anlage to the index
  		$index->addDocument($doc);
  		$index->commit();
	}
	
        public function generateOdf()
	{
		$encode = false;
		$odf = new odf(dirname(__FILE__).'/../../odftmp/Anlage_template.odt');
		
		$htmlConverter = new htmlConverter($odf->getStyleNames());
		$convertedZiel = $htmlConverter->getODF($this->getZiel());
		$convertedMethode = $htmlConverter->getODF($this->getMethode());
		$convertedMaterial = $htmlConverter->getODF($this->getMaterial());
		

	   	$odf->setStyleVars('ptKuerzel', $this->getStunde()->getZim()->getPtKuerzel());
	   	$odf->setStyleVars('ptKuerzel1', $this->getStunde()->getZim()->getPtKuerzel());
	   	$odf->setStyleVars('ptJahr', $this->getStunde()->getZim()->getPtJahr());
	   	$odf->setStyleVars('stunde', $this->getStunde()->getLnr());
	   	$odf->setStyleVars('kuerzel', $this->getKuerzel());
	   	$odf->setStyleVars('lnr', $this->getLnrStr());
	   	$odf->setVars('longName', $this->getLongname(), true,'UTF-8');
	   	$odf->setVars('zeit', $this->getZeit());
		$odf->setVars('ziel', $convertedZiel, $encode,'UTF-8');
		$sections = $odf->setSegment('sections');
		foreach ( $this->getSections() as $section ){
			$convertedInhalt = $htmlConverter->getODF($section->getInhalt());
			$convertedTip = $htmlConverter->getODF($section->getTip());
			
			$sections->setVars('Inhalt', $convertedInhalt, $encode,'UTF-8');
			if ( !$convertedTip )
				$sections->tipSection->delete();
			else {
				$sections->tipSection->setVars('tip', $convertedTip, $encode,'UTF-8');
				$sections->tipSection->merge();
			}
			
			if (!$section->getBild() || !$section->getBild()->getPath()) {
				$sections->setVars('bild', "", $encode, 'UTF-8');
				$caption = "";
			} else {
				$sections->setImage('bild', sfConfig::get('sf_upload_dir').DIRECTORY_SEPARATOR.'bilder'.DIRECTORY_SEPARATOR.$section->getBild()->getPath());
				$caption = $htmlConverter->getODF($section->getBild()->getCaption());
			}
			$sections->setVars('titel', $caption, $encode, 'UTF-8');
			
			$sections->merge();
		}
		$odf->mergeSegment($sections);
		$odf->setVars('methode', $convertedMethode, $encode,'UTF-8');
		$odf->setVars('material', $convertedMaterial, $encode,'UTF-8');
		$odf->setMetaVars('title', $this, true,'UTF-8');
		return $odf;
        }
	
	public function getFilename()
	{
		return $this->getLnrStr().'_'.$this->getKuerzel().'_Anlage_'.$this->getLongname();
	}

	public function __toString()
	{
		return $this->getName(). ($this->getLongname()?' -- '.$this->getLongname():'');
	}

}
